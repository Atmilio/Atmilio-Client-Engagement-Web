import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, collection, getDocs, query, orderBy, onSnapshot } from 'firebase/firestore';

// Define the global Firebase variables (required for Canvas environment)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

const productOptionsData = [
    { id: 'excel-workbook', label: 'Excel Enabled Workbook', basePrice: 500 },
    { id: 'financial-model', label: 'Financial Model', basePrice: 1500 },
    { id: 'fs-implementation', label: 'Financial System Process Implementation', basePrice: 3000 },
    { id: 'data-integration', label: 'Integration of Financial Data to New System', basePrice: 2500 },
];

const employeeCountData = [
    { value: 1, label: '1-10 Employees' },
    { value: 2, label: '11-50 Employees' },
    { value: 3, label: '51-200 Employees' },
    { value: 4, label: '201-1000 Employees' },
    { value: 5, label: '1001-2000 Employees' },
    { value: 6, label: '2001-10000 Employees' },
    { value: 7, label: '10001+ Employees' },
];

const App = () => {
    // UI and State Management
    const [step, setStep] = useState(1);
    const [isQuoteView, setIsQuoteView] = useState(false);
    const [quoteId, setQuoteId] = useState(null);
    const [loading, setLoading] = useState(true);
    const [modal, setModal] = useState({ isOpen: false, message: '' });

    // Quote Data State
    const [clientName, setClientName] = useState('');
    const [clientPhone, setClientPhone] = useState('');
    const [clientEmail, setClientEmail] = useState('');
    const [employeeCount, setEmployeeCount] = useState('');
    const [taxRate, setTaxRate] = useState(8.25);
    const [selectedProducts, setSelectedProducts] = useState([]);

    // Calculated totals
    const [subtotal, setSubtotal] = useState(0);
    const [grandTotal, setGrandTotal] = useState(0);

    // Firebase state
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);

    // Initialize Firebase and Auth
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);

            const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                if (user) {
                    setUserId(user.uid);
                }
                setLoading(false);
            });

            if (!initialAuthToken) {
                signInAnonymously(authInstance);
            } else {
                signInWithCustomToken(authInstance, initialAuthToken);
            }

            setDb(dbInstance);
            setAuth(authInstance);
            
            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setLoading(false);
        }
    }, []);

    // Load quote from URL on initial load if quoteId is present
    useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (id && db) {
            const fetchQuote = async () => {
                setLoading(true);
                try {
                    const quoteRef = doc(db, `artifacts/${appId}/public/data/quotes`, id);
                    const quoteSnap = await getDoc(quoteRef);
                    if (quoteSnap.exists()) {
                        const data = quoteSnap.data();
                        setClientName(data.clientName);
                        setClientPhone(data.clientPhone);
                        setClientEmail(data.clientEmail);
                        setEmployeeCount(data.employeeCount);
                        setTaxRate(data.taxRate);
                        setSelectedProducts(data.selectedProducts);
                        setQuoteId(id);
                        setIsQuoteView(true);
                        setStep(3); // Go directly to summary
                    } else {
                        showModal('Quote not found.');
                        setIsQuoteView(false);
                    }
                } catch (e) {
                    console.error("Error loading quote:", e);
                    showModal('Error loading quote.');
                } finally {
                    setLoading(false);
                }
            };
            fetchQuote();
        } else {
            setLoading(false);
        }
    }, [db]);

    // Update totals whenever selectedProducts, employeeCount, or taxRate changes
    useEffect(() => {
        const selectedMultiplier = employeeCountData.find(e => e.label === employeeCount)?.value || 0;
        const newSubtotal = selectedProducts.reduce((sum, product) => {
            const basePrice = productOptionsData.find(opt => opt.id === product.id)?.basePrice || 0;
            return sum + (basePrice * selectedMultiplier);
        }, 0);
        const newGrandTotal = newSubtotal + (newSubtotal * (taxRate / 100));
        setSubtotal(newSubtotal);
        setGrandTotal(newGrandTotal);
    }, [selectedProducts, employeeCount, taxRate]);

    const showModal = (message) => {
        setModal({ isOpen: true, message });
    };

    const handleProductChange = (e) => {
        const { id, checked } = e.target;
        if (checked) {
            setSelectedProducts(prev => [...prev, { id, specificNeeds: '' }]);
        } else {
            setSelectedProducts(prev => prev.filter(p => p.id !== id));
        }
    };

    const handleNeedsChange = (e, id) => {
        const { value } = e.target;
        setSelectedProducts(prev => prev.map(p => p.id === id ? { ...p, specificNeeds: value } : p));
    };

    const saveQuoteToFirestore = async () => {
        if (!db) {
            showModal('Database not available. Please try again.');
            return;
        }

        const clientData = { clientName, clientPhone, clientEmail };
        const quoteData = {
            ...clientData,
            employeeCount,
            selectedProducts,
            taxRate,
            createdAt: new Date(),
        };

        try {
            setLoading(true);
            const quotesCollectionRef = collection(db, `artifacts/${appId}/public/data/quotes`);
            const docRef = await addDoc(quotesCollectionRef, quoteData);
            setQuoteId(docRef.id);
            setStep(4);
        } catch (e) {
            console.error("Error adding document: ", e);
            showModal('Error saving quote. Please try again.');
        } finally {
            setLoading(false);
        }
    };

    const validateStep1 = () => {
        if (!clientName || !clientPhone || !clientEmail) {
            showModal('Please fill in all client details.');
            return false;
        }
        setStep(2);
    };

    const validateStep2 = () => {
        if (!employeeCount) {
            showModal('Please select the number of employees.');
            return false;
        }
        if (selectedProducts.length === 0) {
            showModal('Please select at least one product option.');
            return false;
        }
        if (selectedProducts.some(p => !p.specificNeeds)) {
            showModal('Please describe your specific needs for all selected products.');
            return false;
        }
        setStep(3);
    };

    const handleDownload = () => {
        const summaryText = `
        Quote Summary

        Client: ${clientName}
        Phone: ${clientPhone}
        Email: ${clientEmail}
        Employees: ${employeeCount}

        Selected Products:
        ${selectedProducts.map(p => {
            const product = productOptionsData.find(opt => opt.id === p.id);
            const finalPrice = product.basePrice * (employeeCountData.find(e => e.label === employeeCount)?.value || 0);
            return `- ${product.label}: $${finalPrice.toFixed(2)}\n  Specific Needs: ${p.specificNeeds}`;
        }).join('\n\n')}

        Subtotal: $${subtotal.toFixed(2)}
        Tax (${taxRate}%): $${(subtotal * (taxRate / 100)).toFixed(2)}
        Grand Total: $${grandTotal.toFixed(2)}
        `;

        const blob = new Blob([summaryText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${clientName}_Quote.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    const copyToClipboard = () => {
        const link = `${window.location.origin}?id=${quoteId}`;
        const tempInput = document.createElement('textarea');
        tempInput.value = link;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showModal('Link copied to clipboard!');
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-xl text-gray-600 font-semibold">Loading...</div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-100 text-gray-800 p-6 flex flex-col items-center">
            {/* Header */}
            <header className="bg-white shadow-md w-full py-4 px-6 md:px-12 fixed top-0 z-10">
                <nav className="flex justify-between items-center max-w-7xl mx-auto">
                    <a href="#" className="text-2xl font-extrabold text-blue-600">Atmilio</a>
                    <div className="space-x-4 hidden md:flex">
                        <a href="#" className="text-gray-600 hover:text-blue-600 font-medium transition-colors">Home</a>
                        <a href="#" className="text-gray-600 hover:text-blue-600 font-medium transition-colors">Services</a>
                        <a href="#" className="text-blue-600 font-semibold transition-colors">Estimator</a>
                        <a href="#" className="text-gray-600 hover:text-blue-600 font-medium transition-colors">Contact</a>
                    </div>
                </nav>
            </header>

            <main className="flex flex-col items-center justify-center p-6 mt-28 mb-12 w-full">
                <div className="bg-white rounded-3xl shadow-xl p-8 max-w-2xl w-full">
                    <h1 className="text-4xl font-extrabold text-gray-800 mb-8 text-center">{isQuoteView ? 'Client Quote' : 'Instant Quote Estimator'}</h1>

                    {/* Step 1: Client Information */}
                    {step === 1 && (
                        <div className="space-y-6">
                            <h2 className="text-2xl font-semibold text-gray-700">Client Information</h2>
                            <input
                                type="text"
                                className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                placeholder="Client Name"
                                value={clientName}
                                onChange={(e) => setClientName(e.target.value)}
                            />
                            <input
                                type="tel"
                                className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                placeholder="Client Phone Number"
                                value={clientPhone}
                                onChange={(e) => setClientPhone(e.target.value)}
                            />
                            <input
                                type="email"
                                className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                placeholder="Client Email"
                                value={clientEmail}
                                onChange={(e) => setClientEmail(e.target.value)}
                            />
                            <div className="flex justify-end">
                                <button
                                    onClick={validateStep1}
                                    className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
                                >
                                    Next
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Step 2: Product Selection */}
                    {step === 2 && (
                        <div className="space-y-6">
                            <h2 className="text-2xl font-semibold text-gray-700">Product Selection</h2>
                            <div>
                                <label className="block text-gray-700 font-medium mb-2">Number of Employees</label>
                                <select
                                    className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                    value={employeeCount}
                                    onChange={(e) => setEmployeeCount(e.target.value)}
                                >
                                    <option value="">Select an employee range</option>
                                    {employeeCountData.map((option) => (
                                        <option key={option.value} value={option.label}>{option.label}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="space-y-4">
                                {productOptionsData.map((product) => (
                                    <div key={product.id} className="bg-gray-50 rounded-lg p-4 shadow-sm transition-shadow hover:shadow-md">
                                        <label className="flex items-center justify-between cursor-pointer">
                                            <div className="flex-1">
                                                <div className="text-lg font-medium text-gray-800">{product.label}</div>
                                                <div className="text-sm text-gray-600">Base Price: ${product.basePrice.toFixed(2)}</div>
                                            </div>
                                            <input
                                                type="checkbox"
                                                id={product.id}
                                                className="h-6 w-6 rounded text-blue-600 focus:ring-blue-500 transition-colors"
                                                checked={selectedProducts.some(p => p.id === product.id)}
                                                onChange={handleProductChange}
                                            />
                                        </label>
                                        {selectedProducts.some(p => p.id === product.id) && (
                                            <textarea
                                                className="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                                rows="3"
                                                placeholder="Describe your specific needs for this product..."
                                                value={selectedProducts.find(p => p.id === product.id)?.specificNeeds}
                                                onChange={(e) => handleNeedsChange(e, product.id)}
                                            />
                                        )}
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-between">
                                <button
                                    onClick={() => setStep(1)}
                                    className="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors"
                                >
                                    Back
                                </button>
                                <button
                                    onClick={validateStep2}
                                    className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
                                >
                                    View Summary
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Step 3: Quote Summary */}
                    {step === 3 && (
                        <div className="space-y-6">
                            <h2 className="text-2xl font-semibold text-gray-700">Quote Summary</h2>
                            <div className="p-4 bg-gray-50 rounded-lg">
                                <p className="text-lg font-semibold text-gray-800">Client: {clientName}</p>
                                <p className="text-gray-600">Employees: {employeeCount}</p>
                            </div>
                            <div className="space-y-4">
                                {selectedProducts.length > 0 ? (
                                    selectedProducts.map((product) => {
                                        const productData = productOptionsData.find(opt => opt.id === product.id);
                                        const multiplier = employeeCountData.find(e => e.label === employeeCount)?.value || 0;
                                        const finalPrice = productData.basePrice * multiplier;
                                        return (
                                            <div key={product.id} className="p-4 bg-white rounded-lg border border-gray-200">
                                                <div className="flex justify-between items-center">
                                                    <span className="font-semibold text-gray-800">{productData.label}</span>
                                                    <span className="font-bold text-gray-800">${finalPrice.toFixed(2)}</span>
                                                </div>
                                                <p className="mt-2 text-sm text-gray-600 italic">{product.specificNeeds}</p>
                                            </div>
                                        );
                                    })
                                ) : (
                                    <p className="text-center text-gray-500">No products selected.</p>
                                )}
                            </div>
                            <div className="p-4 bg-gray-50 rounded-lg">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-gray-600">Subtotal</span>
                                    <span className="font-semibold text-gray-800">${subtotal.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-gray-600">Tax Rate (%)</label>
                                    <input
                                        type="number"
                                        className="w-24 text-right p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={taxRate}
                                        onChange={(e) => setTaxRate(e.target.value)}
                                        readOnly={isQuoteView}
                                    />
                                </div>
                                <div className="flex justify-between items-center pt-2 border-t border-gray-200 mt-2">
                                    <span className="text-xl font-bold text-gray-800">Grand Total</span>
                                    <span className="text-2xl font-extrabold text-blue-600">${grandTotal.toFixed(2)}</span>
                                </div>
                            </div>
                            <div className="flex justify-between mt-6">
                                <button
                                    onClick={() => setStep(2)}
                                    className="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors"
                                >
                                    Back
                                </button>
                                {!isQuoteView && (
                                    <button
                                        onClick={saveQuoteToFirestore}
                                        className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
                                    >
                                        Generate Shareable Link
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Step 4: Shareable Link */}
                    {step === 4 && (
                        <div className="space-y-6 text-center">
                            <h2 className="text-2xl font-semibold text-gray-700">Quote Saved!</h2>
                            <p className="text-gray-600">Share this link with your client.</p>
                            <div className="relative p-4 bg-gray-100 rounded-lg break-words shadow-inner">
                                <span className="text-blue-600 font-mono select-all">
                                    {window.location.origin}?id={quoteId}
                                </span>
                            </div>
                            <div className="flex justify-center space-x-4">
                                <button
                                    onClick={copyToClipboard}
                                    className="px-6 py-3 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-900 transition-colors"
                                >
                                    Copy Link
                                </button>
                                <button
                                    onClick={handleDownload}
                                    className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
                                >
                                    Download Summary
                                </button>
                            </div>
                            <button
                                onClick={() => {
                                    setStep(1);
                                    setQuoteId(null);
                                    setClientName('');
                                    setClientPhone('');
                                    setClientEmail('');
                                    setEmployeeCount('');
                                    setSelectedProducts([]);
                                }}
                                className="mt-4 px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors"
                            >
                                Create New Quote
                            </button>
                        </div>
                    )}
                </div>
            </main>

            {/* Modal */}
            {modal.isOpen && (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full text-center">
                        <p className="text-lg mb-6 text-gray-800">{modal.message}</p>
                        <button
                            onClick={() => setModal({ isOpen: false, message: '' })}
                            className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            OK
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};

export default App;

